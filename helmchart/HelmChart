#!/bin/bash
# Copyright 2019 The Kubernetes Authors.
# SPDX-License-Identifier: Apache-2.0

# Helm chart
#
# Reads a file like this
#
#  apiVersion: kustless.github.io/v0
#  kind: HelmChart
#  metadata:
#    name: dummy
#  chartName: nameOfStableChart
#  chartS3Url: s3UrlWithoutScheme
#  chartHome: /abs/path/local/chart/storage
#  valuesFile: /abs/path/to/local/values/file
#  helmHome: /abs/path/to/helm/config
#  helmBin: /abs/path/to/helmBin
#
# fetches the given chart from stable/$chartName or download from s3,
# and inflates it to stdout, using the given values file.
#
# chartDir default: $TMP_DIR/charts
#
# Example execution:
# ./plugin/kustless.github.io/v0/HelmChart generators.yaml

# TODO: allow specification of a specific chart VERSION
# so this test doesn't break every time minecraft is upgraded :P
# See https://github.com/helm/helm/issues/4008

set -ex

# Yaml parsing is a ridiculous thing to do in bash,
# but let's try:
function parseYaml {
  local file=$1
  while read -r line
  do
    local k=${line%%:*}
    local v=${line#*:}

    [ "$k" == "chartName" ] && chartName=$v
    [ "$k" == "chartHome" ] && chartHome=$v
    [ "$k" == "chartS3Url" ] && chartS3Url=$v
    [ "$k" == "valuesFile" ] && valuesFile=$v
    [ "$k" == "helmHome" ] && helmHome=$v
    [ "$k" == "helmBin" ] && helmBin=$v
  done <"$file"

  # Trim leading space
  chartName="${chartName#"${chartName%%[![:space:]]*}"}"
  chartS3Url="${chartS3Url#"${chartS3Url%%[![:space:]]*}"}"
  chartHome="${chartHome#"${chartHome%%[![:space:]]*}"}"
  valuesFile="${valuesFile#"${valuesFile%%[![:space:]]*}"}"
  helmBin="${helmBin#"${helmBin%%[![:space:]]*}"}"
  helmHome="${helmHome#"${helmHome%%[![:space:]]*}"}"
}

TMP_DIR=$(mktemp -d)

parseYaml $1

# Where all the files generated by 'helm init' live.
if [ -z "$helmHome" ]; then
  helmHome=$TMP_DIR/dotHelm
fi

# Where helm charts are unpacked.
if [ -z "$chartHome" ]; then
  chartHome=$TMP_DIR/charts
fi

if [ -z "$helmBin" ]; then
  helmBin=helm
fi

if [ -z "$valuesFile" ]; then
  valuesFile=$chartHome/$chartName/values.yaml
fi

function doHelm {
  $helmBin --home $helmHome $@
}


if [ ! -d "$helmHome" ]; then
  # The init command is extremely chatty
  doHelm init --client-only >& /dev/null
fi

if [ ! -d "$chartHome/$chartName" ]; then
  if [ ! -z "$chartS3Url" ]; then
    mkdir -p $chartHome/$chartName
    aws s3 cp s3://$chartS3Url - | tar -C $chartHome/$chartName -zxf - --strip-components 1
  else
    doHelm fetch --untar \
        --untardir $chartHome \
        stable/$chartName
  fi
fi

doHelm template \
    --values $valuesFile \
    $chartHome/$chartName

/bin/rm -rf $TMP_DIR
